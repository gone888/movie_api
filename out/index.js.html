<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// importing modules
const express = require("express"),
  bodyParser = require("body-parser"),
  uuid = require("uuid"),
  morgan = require("morgan"),
  mongoose = require("mongoose"),
  Models = require("./models.js");
const bcrypt = require("bcrypt");
const app = express();
const Movies = Models.Movie;
const Users = Models.User;

app.use(bodyParser.json());

// allows access to documentation.html
app.use(express.static("public"));

// default endpoint
app.get("/", (req, res) => {
  res.send("Welcome to my myFlix API!");
});

// validation
const { check, validationResult } = require("express-validator");

// importing passport
const passport = require("passport");
require("./passport");

// CORS implementation and restricting access
const cors = require("cors");
let allowedOrigins = [
  "http://localhost:8080",
  "http://testsite.com",
  "http://localhost:1234",
  "http://localhost:4200",
  "https://myflixbb.netlify.app",
  "https://gone888.github.io",
];

app.use(
  cors({
    origin: (origin, callback) => {
      if (!origin) return callback(null, true);
      if (allowedOrigins.indexOf(origin) === -1) {
        // If a specific origin isnâ€™t found on the list of allowed origins
        let message =
          "The CORS policy for this application doesn't allow access from origin " +
          origin;
        return callback(new Error(message), false);
      }
      return callback(null, true);
    },
  })
);

// importing auth.js
let auth = require("./auth")(app);

// local database connection.
// mongoose.connect("mongodb://localhost:27017/cfDB", {
//   useNewUrlParser: true,
//   useUnifiedTopology: true,
// });

// atlas database connection
mongoose.connect(process.env.CONNECTION_URI, {
  useNewUrlParser: true,
  useUnifiedTopology: true,
});

// logging to console using morgan middleware
app.use(morgan("common"));

/**
 * @description Get a list of all movies
 * @name GET /movies
 * @example
 * Query Parameters
 * None
 * @example
 * Authentication: Bearer token (JWT)
 * @example
 * Request body data format
 * None
 * @example
 * Response body data format
 * A JSON object holding a list of all movies in the database
 */
app.get(
  "/movies",
  passport.authenticate("jwt", { session: false }),
  async (req, res) => {
    await Movies.find()
      .then((movies) => {
        res.status(201).json(movies);
      })
      .catch((error) => {
        console.error(error), res.status(500).send("Error: " + error);
      });
  }
);

/**
 * @description Get a list of all users
 * @name GET /users
 * @example
 * Query Parameters
 * None
 * @example
 * Authentication: Bearer token (JWT)
 * @example
 * Request body data format
 * None
 * @example
 * Response body data format
 * A JSON object holding a list of all users in the database
 */
app.get(
  "/users",
  passport.authenticate("jwt", { session: false }),
  async (req, res) => {
    await Users.find()
      .then((users) => {
        res.status(201).json(users);
      })
      .catch((error) => {
        console.error(error), res.status(500).send("Error: " + error);
      });
  }
);

/**
 * @description Get data about a single movie by it's title
 * @name GET /movies/{Title}
 * @example
 * Query Parameters
 * Title
 * @example
 * Authentication: Bearer token (JWT)
 * @example
 * Request body data format
 * None
 * @example
 * Response body data format
 * A JSON object holding the data of the specified movie, containing its title, description, genre, director, imageURL, and if the movie is featured. Example:
    {
    "Genre": {
      "Name": "Action",
      "Description": "The action genre in media, like movies, books, and video games, is characterized by fast-paced, physical conflict and exciting scenarios where protagonists overcome challenges through physical feats, often involving fights, chases, or battles against powerful antagonists."
    },
    "Director": {
      "Name": "Christopher Nolan",
      "Bio": "Christopher Nolan is a highly acclaimed British-American filmmaker, known for his complex, visually striking, and narrative-driven blockbusters. Born in London on July 30, 1970, he is celebrated for his innovative storytelling techniques and has directed films that have achieved both critical and commercial success",
      "Birth": "1970"
    },
      "Actors": [],
      "_id": "689a6e9032c527f294eec4aa",
      "Title": "The Dark Knight",
      "Description": "When a menace known as the Joker wreaks havoc and chaos on the people of Gotham, Batman, James Gordon and Harvey Dent must work together to put an end to the madness.",
      "ImagePath": "thedarkknight.png",
      "Featured": false
    }
 */
app.get(
  "/movies/:Title",
  passport.authenticate("jwt", { session: false }),
  async (req, res) => {
    await Movies.find({ Title: req.params.Title })
      .then((movie) => {
        res.status(201).json(movie);
      })
      .catch((error) => {
        console.error(error), res.status(500).send("Error: " + error);
      });
  }
);

/**
 * @description Get data about a single user by their username
 * @name GET /users/{username}
 * @example
 * Query Parameters
 * username
 * @example
 * Authentication: Bearer token (JWT)
 * @example
 * Request body data format
 * None
 * @example
 * Response body data format
 * A JSON object holding the users information. Example:
  {
  "Username": "test123",
  "Password": "test123",
  "Email": "test123@gmail.com",
  "Birthday": "2000-01-01T00:00:00.000Z",
  "FavoriteMovies": [],
  "_id": "689bfb275ac5bff32267fce2",
  "__v": 0
  }
 */
app.get(
  "/user/:username",
  passport.authenticate("jwt", { session: false }),
  async (req, res) => {
    await Users.findOne({ Username: req.params.username })
      .then((user) => {
        res.status(201).json({
          user: {
            Username: user.Username,
            Email: user.Email,
            Birthday: user.Birthday,
            FavoriteMovies: user.FavoriteMovies,
          },
        });
      })
      .catch((error) => {
        console.error(error), res.status(500).send("Error: " + error);
      });
  }
);

/**
 * @description Get the description of a genre
 * @name GET /genre/{genreName}
 * @example
 * Query Parameters
 * genreName
 * @example
 * Authentication: Bearer token (JWT)
 * @example
 * Request body data format
 * None
 * @example
 * Response body data format
 * 	A JSON object holding the description of the specified genre. Example:
    {
    "Name": "Action",
    "Description": "The action genre in media, like movies, books, and video games, is characterized by fast-paced, physical conflict and exciting scenarios where protagonists overcome challenges through physical feats, often involving fights, chases, or battles against powerful antagonists."
    }
 */
app.get(
  "/genre/:genreName",
  passport.authenticate("jwt", { session: false }),
  async (req, res) => {
    await Movies.findOne({ "Genre.Name": req.params.genreName })
      .then((genre) => {
        res.json(genre.Genre);
      })
      .catch((error) => {
        console.error(error), res.status(500).send("Error: " + error);
      });
  }
);

/**
 * @description Get the data of a director
 * @name GET /director/{directorsName}
 * @example
 * Query Parameters
 * directorsName
 * @example
 * Authentication: Bearer token (JWT)
 * @example
 * Request body data format
 * None
 * @example
 * Response body data format
 * 	A JSON object holding the description of the specified genre. Example:
    A JSON object holding the data of the specified director, containing their name, a brief description, and birth year. Example:
    {
    "Name": "Christopher Nolan",
    "Bio": "Christopher Nolan is a highly acclaimed British-American filmmaker, known for his complex, visually striking, and narrative-driven blockbusters. Born in London on July 30, 1970, he is celebrated for his innovative storytelling techniques and has directed films that have achieved both critical and commercial success",
    "Birth": "1970"
    }
 */
app.get(
  "/director/:directorsName",
  passport.authenticate("jwt", { session: false }),
  async (req, res) => {
    await Movies.findOne({ "Director.Name": req.params.directorsName })
      .then((director) => {
        res.json(director.Director);
      })
      .catch((error) => {
        console.error(error), res.status(500).send("Error: " + error);
      });
  }
);

/**
 * @description Create a new user
 * @name POST /users
 * @example
 * Query Parameters
 * None
 * @example
 * Authentication: Bearer token (JWT)
 * @example
 * Request body data format
 * A JSON object with the data of the user to be added. Example:
  {
  "Username": "test123",
  "Password": "test123",
  "Email": "test123@gmail.com",
  "Birthday": "2001-01-01"
  }
 * @example
 * Response body data format
 * 	A JSON object holding the description of the specified genre. Example:
    A JSON object holding the data of the specified director, containing their name, a brief description, and birth year. Example:
    {
    "Name": "Christopher Nolan",
    "Bio": "Christopher Nolan is a highly acclaimed British-American filmmaker, known for his complex, visually striking, and narrative-driven blockbusters. Born in London on July 30, 1970, he is celebrated for his innovative storytelling techniques and has directed films that have achieved both critical and commercial success",
    "Birth": "1970"
    }
 */
app.post(
  "/users",
  [
    check("Username", "Username is required").isLength({ min: 5 }),
    check(
      "Username",
      "Username contains non alphanumeric characters - not allowed."
    ).isAlphanumeric(),
    check("Password", "Password is required").not().isEmpty(),
    check("Email", "Email does not appear to be valid").isEmail(),
  ],
  async (req, res) => {
    let errors = validationResult(req);

    if (!errors.isEmpty()) {
      return res.status(422).json({ errors: errors.array() });
    }

    let hashedPassword = Users.hashPassword(req.body.Password);
    await Users.findOne({ Username: req.body.Username })
      .then((user) => {
        if (user) {
          return res.status(400).send(req.body.Username + " already exists");
        } else {
          Users.create({
            Username: req.body.Username,
            Password: hashedPassword,
            Email: req.body.Email,
            Birthday: req.body.Birthday,
          })
            .then((user) => {
              res.status(201).json(user);
            })
            .catch((error) => {
              console.error(error);
              res.status(500).send("Error: " + error);
            });
        }
      })
      .catch((error) => {
        console.error(error);
        res.status(500).send("Error: " + error);
      });
  }
);

/**
 * @description Add a movie to a users FavoriteMovies array
 * @name POST /users/{username}/movies/{movieID}
 * @example
 * Query Parameters
 * username, movieID
 * @example
 * Authentication: Bearer token (JWT)
 * @example
 * Request body data format
 * None
 * @example
 * Response body data format
 * A message indicating whether the specified movie had been succesfully added to the users FavoriteMovies array
 */
app.post("/users/:username/movies/:movieID", async (req, res) => {
  await Users.findOneAndUpdate(
    { Username: req.params.username },
    {
      $push: { FavoriteMovies: req.params.movieID },
    },
    { new: true }
  ) // This line makes sure that the updated document is returned
    .then((updatedUser) => {
      res.json(updatedUser);
    })
    .catch((err) => {
      console.error(err);
      res.status(500).send("Error: " + err);
    });
});

/**
 * @description Update a users information
 * @name PUT /users/{username}
 * @example
 * Query Parameters
 * username
 * @example
 * Authentication: Bearer token (JWT)
 * @example
 * Request body data format
 * A JSON object holding the desired information to update. Example:
  {
  "Username": "test123",
  "Password": "test123",
  "Email": "test123@gmail.com",
  "Birthday": "2000-01-00"
  }
 * @example
 * Response body data format
 * A JSON object holding the updated users information. Example:
  {
  "Username": "test123new",
  "Password": "test123new",
  "Email": "test123new@gmail.com",
  "Birthday": "2000-00-02T00:00:00.000Z",
  "FavoriteMovies": [],
  "_id": "689bfb275ac5bff32267fce2",
  "__v": 0
  }
 */
app.put(
  "/users/:username",
  [
    check("Username", "Username is required").isLength({ min: 5 }),
    check(
      "Username",
      "Username contains non alphanumeric characters - not allowed."
    ).isAlphanumeric(),
    check("Password", "Password is required").not().isEmpty(),
    check("Email", "Email does not appear to be valid").isEmail(),
  ],
  passport.authenticate("jwt", { session: false }),
  async (req, res) => {
    let errors = validationResult(req);

    if (!errors.isEmpty()) {
      return res.status(422).json({ errors: errors.array() });
    }
    if (req.user.Username !== req.params.username) {
      return res.status(400).send("Permission denied");
    }
    let hashedPassword = Users.hashPassword(req.body.Password);
    await Users.findOneAndUpdate(
      { Username: req.params.username },
      {
        $set: {
          Username: req.body.Username,
          Password: hashedPassword,
          Email: req.body.Email,
          Birthday: req.body.Birthday,
        },
      },
      { new: true }
    ) // This line makes sure that the updated document is returned
      .then((updatedUser) => {
        res.json(updatedUser);
      })
      .catch((err) => {
        console.error(err);
        res.status(500).send("Error: " + err);
      });
  }
);

/**
 * @description Delete a movie from the users FavoriteMovies array
 * @name DELETE /users/{username}/movies/{movieID}
 * @example
 * Query Parameters
 * username, movieID
 * @example
 * Authentication: Bearer token (JWT)
 * @example
 * Request body data format
 * A JSON object holding the desired information to update. Example:
  {
  "Username": "test123",
  "Password": "test123",
  "Email": "test123@gmail.com",
  "Birthday": "2000-01-00"
  }
 * @example
 * Response body data format
 * A JSON object holding the users data including the FavoriteMovies array showing that the movie has been successfully removed. Example:
  {
  "_id": "689bfd512f184c90d9177a84",
  "Username": "test123new",
  "Password": "test123new",
  "Email": "test123new@gmail.com",
  "Birthday": "2000-00-01T00:00:00.000Z",
  "FavoriteMovies": [],
  "__v": 0
  }
 */
app.delete(
  "/users/:username/movies/:movieID",
  passport.authenticate("jwt", { session: false }),
  async (req, res) => {
    await Users.findOneAndUpdate(
      { Username: req.params.username },
      {
        $pull: { FavoriteMovies: req.params.movieID },
      },
      { new: true }
    ) // This line makes sure that the updated document is returned
      .then((updatedUser) => {
        res.json(updatedUser);
      })
      .catch((err) => {
        console.error(err);
        res.status(500).send("Error: " + err);
      });
  }
);

/**
 * @description Delete a user by their username
 * @name DELETE /users/{username}
 * @example
 * Query Parameters
 * username
 * @example
 * Authentication: Bearer token (JWT)
 * @example
 * Request body data format
 * A JSON object holding the desired information to update. Example:
 * None
 * @example
 * Response body data format
 * A message indicating whether the specified user was sucessfully deleted.
 */
app.delete(
  "/users/:username",
  passport.authenticate("jwt", { session: false }),
  async (req, res) => {
    await Users.findOneAndDelete({ Username: req.params.username })
      .then((user) => {
        if (!user) {
          res.status(400).send(req.params.username + " was not found");
        } else {
          res.status(200).send(req.params.username + " was deleted.");
        }
      })
      .catch((err) => {
        console.error(err);
        res.status(500).send("Error: " + err);
      });
  }
);

// this is just a test error
app.get("/test-error-sync", (req, res) => {
  throw new Error("This is a synchronous test error!");
});

// error handling middleware function
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).send("Something broke!");
});

// listening for requests
const port = process.env.PORT || 8080;
app.listen(port, "0.0.0.0", () => {
  console.log("Listening on Port " + port);
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#DELETE/users/%257Busername%257D">DELETE /users/{username}</a></li><li><a href="global.html#DELETE/users/%257Busername%257D/movies/%257BmovieID%257D">DELETE /users/{username}/movies/{movieID}</a></li><li><a href="global.html#GET/director/%257BdirectorsName%257D">GET /director/{directorsName}</a></li><li><a href="global.html#GET/genre/%257BgenreName%257D">GET /genre/{genreName}</a></li><li><a href="global.html#GET/movies">GET /movies</a></li><li><a href="global.html#GET/movies/%257BTitle%257D">GET /movies/{Title}</a></li><li><a href="global.html#GET/users">GET /users</a></li><li><a href="global.html#GET/users/%257Busername%257D">GET /users/{username}</a></li><li><a href="global.html#POST/login">POST /login</a></li><li><a href="global.html#POST/users">POST /users</a></li><li><a href="global.html#POST/users/%257Busername%257D/movies/%257BmovieID%257D">POST /users/{username}/movies/{movieID}</a></li><li><a href="global.html#PUT/users/%257Busername%257D">PUT /users/{username}</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Sat Oct 25 2025 14:24:35 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
